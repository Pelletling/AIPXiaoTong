using AIPXiaoTong.IService;
using AIPXiaoTong.Model;
using AIPXiaoTong.Model.API;
using AIPXiaoTong.Model.Site;
using Framework.Common;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Web;
using System.Web.Mvc;
using VSP.Pay;

namespace AIPXiaoTong.Site.Controllers
{
    [AllowAnonymous]
    public class APIController : Controller
    {

        private IEmployeeService iEmployeeService;
        private IOrderBookingService iOrderBookingService;
        private IOrderHousePaymentService iOrderHousePaymentService;
        private IOrderPaidService iOrderPaidService;
        private IMemberManagementService iMemberManagementService;
        private IProjectManagementService iProjectManagementService;
        private IHouseTypeShowService iHouseTypeShowService;

        public APIController(IEmployeeService iEmployeeService,
                              IOrderBookingService iOrderBookingService,
                              IOrderHousePaymentService iOrderHousePaymentService,
                              IOrderPaidService iOrderPaidService,
                              IMemberManagementService iMemberManagementService,
                              IProjectManagementService iProjectManagementService,
                              IHouseTypeShowService iHouseTypeShowService)
        {
            this.iEmployeeService = iEmployeeService;
            this.iOrderBookingService = iOrderBookingService;
            this.iOrderHousePaymentService = iOrderHousePaymentService;
            this.iOrderPaidService = iOrderPaidService;
            this.iMemberManagementService = iMemberManagementService;
            this.iProjectManagementService = iProjectManagementService;
            this.iHouseTypeShowService = iHouseTypeShowService;
        }

        //protected override void OnException(ExceptionContext filterContext)
        //{
        //    base.OnException(filterContext);
        //}

        // GET: API
        public string Login(LoginRequest request)
        {
            var result = new LoginResponse() { requestno = request.requestno };

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var employee = iEmployeeService.Get(t => t.Code == request.employeecode && t.Merchant.Code == request.merchantcode);

                if (employee == null)
                    throw new APIException("账号不存在");

                if (employee.Password != request.password)
                    throw new APIException("密码不正确");

                result.employeecode = employee.Code;
                result.employeeid = employee.ID.ToString();
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }

        public string QueryOrderBookingDetail(QueryOrderBookingDetailRequst request)
        {
            var result = new QueryOrderBookingDetailResponse() { requestno = request.requestno };

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var orderBooking = iOrderBookingService.Get(t => t.Merchant.Code == request.merchantcode && t.OrderNumber == request.ordernumber);

                if (orderBooking == null)
                    throw new APIException("订单不存在");

                result.ordernumber = orderBooking.OrderNumber;
                result.orderbookingid = orderBooking.ID.ToString();
                result.merchantname = orderBooking.Merchant.Name.ToString();
                result.projectname = orderBooking.ProjectManagement.ProjetName.ToString();
                result.equipmentnumber = orderBooking.EquipmentNumber;
                result.membername = orderBooking.Member.Name;
                result.membermobile = orderBooking.Member.Mobile;
                result.memberidnumber = orderBooking.Member.IDNumber;
                result.ordertime = orderBooking.OrderTime.ToString();
                result.remark = orderBooking.Remark;
                result.employeename = orderBooking.Employee.Name.ToString();

            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }

        public string QueryOrderBookingList(QueryOrderBookingListRequst request)
        {
            var result = new QueryOrderBookingListResponse() { requestno = request.requestno };

            var model = new OrderBookingQM();

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var list = iOrderBookingService.GetListModel<OrderBookingLM, OrderBookingQM>(model);

                if (list.Count == 0)
                    throw new APIException("订单不存在");

                result.orderBookingList = new List<QueryOrderBookingListResponse.OrderBookingList>();

                for (int i = 0; i < list.Count; i++)
                {
                    result.orderBookingList.Add(new QueryOrderBookingListResponse.OrderBookingList()
                    {
                        OrderNumber=list[i].OrderNumber,
                        MerchantName=list[i].MerchantName,
                        ProjectName=list[i].ProjectName,
                        EquipmentNumber=list[i].EquipmentNumber,
                        MemberName = list[i].MemberName,
                        MemberMobile = list[i].MemberMobile,
                        MemberIDNumber=list[i].MemberIDNumber,
                        OrderTime=list[i].OrderTime,
                        Remark=list[i].Remark,
                        EmployeeName=list[i].EmployeeName,
                        
                    });
                }
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }


        public string QueryOrderHousePaymentDetail(QueryOrderHousePaymentDetailRequst request)
        {
            var result = new QueryOrderHousePaymentDetailResponse() { requestno = request.requestno };

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var orderHousePayment = iOrderHousePaymentService.Get(t => t.Merchant.Code == request.merchantcode && t.OrderNumber == request.ordernumber);

                if (orderHousePayment == null)
                    throw new APIException("订单不存在");

                result.orderhousepaymentid = orderHousePayment.ID.ToString();
                result.ordernumber = orderHousePayment.OrderNumber;
                result.merchantname = orderHousePayment.Merchant.Name;
                result.projectname = orderHousePayment.ProjectManagement.ProjetName.ToString();
                result.equipmentnumber = orderHousePayment.EquipmentNumber;
                result.transactionamount = orderHousePayment.TransactionAmount.ToString();
                result.serialnumber = orderHousePayment.SerialNumber.Trim();
                result.membername = orderHousePayment.Member.Name;
                result.membermobile = orderHousePayment.Member.Mobile;
                result.memberidnumber = orderHousePayment.Member.IDNumber;
                result.paymentstatus = orderHousePayment.PaymentStatus.ToString();
                result.paymentstatusdesc = orderHousePayment.PaymentStatusDesc;
                result.paymenttype = orderHousePayment.PaymentType.ToString();
                result.paymenttypedesc = orderHousePayment.PaymentTypeDesc;
                result.status = orderHousePayment.Status.ToString();
                result.statusdesc = orderHousePayment.StatusDesc.ToString();
                result.createdatetime = orderHousePayment.CreateDatetime.ToString();
                result.bankcardnumber = orderHousePayment.BankCardNumber;
                result.employeename = orderHousePayment.Employee.Name.ToString();
                result.remark = orderHousePayment.Remark;

            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }


        public string QueryOrderHousePaymentList(QueryOrderHousePaymentListRequst request)
        {
            var result = new QueryOrderHousePaymentListResponse() { requestno = request.requestno };

            var model = new OrderHousePaymentQM();

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var list = iOrderHousePaymentService.GetListModel<OrderHousePaymentLM, OrderHousePaymentQM>(model);

                if (list.Count == 0)
                    throw new APIException("订单不存在");

                result.orderHousePaymentList = new List<QueryOrderHousePaymentListResponse.OrderHousePaymentList>();

                for (int i = 0; i < list.Count; i++)
                {
                    result.orderHousePaymentList.Add(new QueryOrderHousePaymentListResponse.OrderHousePaymentList()
                    {
                        OrderNumber = list[i].OrderNumber,
                        MerchantName = list[i].MerchantName,
                        ProjectName = list[i].ProjectName,
                        EquipmentNumber = list[i].EquipmentNumber,
                        TransactionAmount=list[i].TransactionAmount,
                        SerialNumber=list[i].SerialNumber.Trim(),
                        MemberName = list[i].MemberName,
                        MemberMobile = list[i].MemberMobile,
                        MemberIDNumber = list[i].MemberIDNumber,        
                        EmployeeName = list[i].EmployeeName,                       
                        PaymentStatusDesc=list[i].PaymentStatusDesc,
                        PaymentTypeDesc=list[i].PaymentTypeDesc,
                        StatusDesc=list[i].StatusDesc,
                        PaymentStatus=list[i].PaymentStatus,
                        PaymentType=list[i].PaymentType,
                        Status=list[i].Status,
                      
                    });
                }
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }


        public string QueryOrderPaidDetail(QueryOrderPaidDetailRequst request)
        {
            var result = new QueryOrderPaidDetailResponse() { requestno = request.requestno };

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var orderPaid = iOrderPaidService.Get(t => t.Merchant.Code == request.merchantcode && t.OrderNumber == request.ordernumber);

                if (orderPaid == null)
                    throw new APIException("订单不存在");

                result.orderpaidid = orderPaid.ID.ToString();
                result.merchantname = orderPaid.Merchant.Name;
                result.ordernumber = orderPaid.OrderNumber;
                result.projectname = orderPaid.ProjectManagement.ProjetName;
                result.equipmentnumber = orderPaid.EquipmentNumber;
                result.transactionamount = orderPaid.TransactionAmount.ToString();
                result.serialnumber = orderPaid.SerialNumber.Trim();
                result.membername = orderPaid.Member.Name;
                result.membermobile = orderPaid.Member.Mobile;
                result.memberidnumber = orderPaid.MemberIDNumber;
                result.paymentstatus = orderPaid.PaymentStatus.ToString();
                result.paymentstatusdesc = orderPaid.PaymentStatusDesc;
                result.paymenttype = orderPaid.PaymentType.ToString();
                result.paymenttypedesc = orderPaid.PaymentTypeDesc;
                result.bankcardnumber = orderPaid.BankCardNumber;
                result.remark = orderPaid.Remark;
                result.status = orderPaid.Status.ToString();
                result.statusdesc = orderPaid.StatusDesc.ToString();
                result.createdatetime = orderPaid.CreateDatetime.ToString();
                result.employeename = orderPaid.Employee.Name.ToString();

            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }

        public string QueryOrderPaidList(QueryOrderPaidListRequst request)
        {
            var result = new QueryOrderPaidListResponse() { requestno = request.requestno };

            var model = new OrderPaidQM();

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var list = iOrderPaidService.GetListModel<OrderPaidLM, OrderPaidQM>(model);

                if (list.Count == 0)
                    throw new APIException("订单不存在");

                result.orderPaidList = new List<QueryOrderPaidListResponse.OrderPaidList>();
                for (int i = 0; i < list.Count; i++)
                {
                    result.orderPaidList.Add(new QueryOrderPaidListResponse.OrderPaidList()
                    {
                        OrderNumber = list[i].OrderNumber,
                        MerchantName = list[i].MerchantName,
                        ProjectName = list[i].ProjectName,
                        EquipmentNumber = list[i].EquipmentNumber,
                        TransactionAmount = list[i].TransactionAmount,
                        SerialNumber = list[i].SerialNumber.Trim(),
                        MemberName = list[i].MemberName,
                        MemberMobile = list[i].MemberMobile,
                        MemberIDNumber = list[i].MemberIDNumber,
                        EmployeeName = list[i].EmployeeName,
                        PaymentStatusDesc = list[i].PaymentStatusDesc,
                        PaymentTypeDesc = list[i].PaymentTypeDesc,
                        StatusDesc = list[i].StatusDesc,
                        PaymentStatus = list[i].PaymentStatus,
                        PaymentType = list[i].PaymentType,
                        Status = list[i].Status,
                    });
                }
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }


        public string QueryProjectDetail(QueryProjectDetailRequst request)  //查询单个项目信息
        {
            var result = new QueryProjectDetailResponse() { requestno = request.requestno };

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var project = iProjectManagementService.Get(t => t.Merchant.Code == request.merchantcode && t.ProjetName == request.projetname);

                if (project == null)
                    throw new APIException("订单不存在");

                result.projetname = project.ProjetName.Trim();
                result.projectimage = project.ProjectImage.Trim();
                result.projectamount = project.ProjectAmount.ToString();
                result.residueamount = project.ResidueAmount.ToString();
                result.deadline = project.Deadline.ToString();
                result.description = project.Description.Trim();
                result.provincename = project.ProvinceName.Trim();
                result.cityname = project.CityName.Trim();
                result.status = project.Status.ToString();
                result.statusdesc = project.StatusDesc;
              

                result.advertisingimge = project.AdvertisingImge.Trim();    //广告需转成list再返回
              
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }

        public string QueryProjectList(QueryProjectListRequst request)
        {
            var result = new QueryProjectListResponse() { requestno = request.requestno };

            var model = new ProjectManagementQM();

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var list = iProjectManagementService.GetListModel<ProjectManagementLM, ProjectManagementQM>(model);

                if (list.Count == 0)
                    throw new APIException("订单不存在");

                result.projectList = new List<QueryProjectListResponse.ProjectList>();
                for (int i = 0; i < list.Count; i++)
                {
                    result.projectList.Add(new QueryProjectListResponse.ProjectList()
                    {

                        MerchantName = list[i].MerchantName,
                        ProjetName = list[i].ProjetName.Trim(),
                        ProjectImage = list[i].ProjectImage.Trim(),
                        ProjectAmount = list[i].ProjectAmount,
                        ResidueAmount=list[i].ResidueAmount,
                        Deadline=list[i].Deadline,
                        Description=list[i].Description,
                        StatusDesc=list[i].StatusDesc,
                        Status=list[i].Status,
                        ProvinceName=list[i].ProvinceName,
                        CityName=list[i].CityName,

                        AdvertisingImge=list[i].AdvertisingImge,  //广告需转成list再返回

                    });
                }
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }

        public string QueryHouseTypeShowDetail(QueryHouseTypeShowDetailRequst request)  //查询单个项目信息
        {
            var result = new QueryHouseTypeShowDetailResponse() { requestno = request.requestno };

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var houseTypeShow = iHouseTypeShowService.Get(t => t.Merchant.Code == request.merchantcode && t.HouseTypeName == request.housetypename);

                if (houseTypeShow == null)
                    throw new APIException("订单不存在");

                result.projetname = houseTypeShow.ProjectName.Trim();
                result.housetypename = houseTypeShow.HouseTypeName.Trim();
                result.housethumbnailimage = houseTypeShow.HouseThumbnailImage;
                result.housetypearea = houseTypeShow.HouseTypeArea.ToString();
                result.description = houseTypeShow.Description.Trim();
                result.content = houseTypeShow.Content.Trim();


                result.houseshowimage = houseTypeShow.HouseShowImage; //广告需转成list再返回

            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }

        public string QueryHouseTypeShowList(QueryHouseTypeShowListRequst request)
        {
            var result = new QueryHouseTypeShowListResponse() { requestno = request.requestno };

            var model = new HouseTypeShowQM();

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                var list = iHouseTypeShowService.GetListModel<HouseTypeShowLM, HouseTypeShowQM>(model);

                if (list.Count == 0)
                    throw new APIException("订单不存在");

                result.houseTypeShowList = new List<QueryHouseTypeShowListResponse.QueryHouseTypeShowList>();
                for (int i = 0; i < list.Count; i++)
                {
                    result.houseTypeShowList.Add(new QueryHouseTypeShowListResponse.QueryHouseTypeShowList()
                    {
                        MerchantName=list[i].MerchantName,
                        ProjectName=list[i].ProjectName,
                        HouseTypeName=list[i].HouseTypeName,
                        HouseTypeArea=list[i].HouseTypeArea,
                        Description=list[i].Description,
                        Content = list[i].Content,

                        HouseThumbnailImage =list[i].HouseThumbnailImage,
                        HouseShowImage=list[i].HouseShowImage,         //广告需转成list再返回

                    });
                }
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            return JsonHelper.Serialize(result);
        }


























        public string CreateOrderBooking(CreateOrderBookingRequst request)    //预约订单创建接口
        {
            var result = new CreateOrderBookingResponse() { requestno = request.requestno };

            var entity = new OrderBooking();

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                entity.MerchantID = request.MerchantID;
                entity.OrderNumber = GuidHelper.GenUniqueId();
                entity.ProjectManagementID = request.ProjectManagementID;
                entity.EquipmentNumber = request.EquipmentNumber;
                entity.OrderTime = request.OrderTime;
                entity.Remark = request.Remark;
                entity.EmployeeID = request.EmployeeID;
                entity.MemberID = request.MemberID;

                iOrderBookingService.Save(entity);
                iOrderBookingService.Commit();
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            result.ordernumber = entity.OrderNumber;

            return JsonHelper.Serialize(result);
        }
        //VSPExec vspExec = null;
        //public class RspObj
        //{
        //    public String appid;
        //    public String cusid;
        //    public String trxcode;
        //    public String timestamp;
        //    public String randomstr;
        //    public String sign;
        //    public String bizseq;
        //    public String retcode;
        //    public String retmsg;
        //    public String amount;
        //    public String trxreserve;

        //    public void init(String retCode, String retMsg, String APPID, String CUSID)
        //    {
        //        retcode = retCode;
        //        retmsg = retMsg;
        //        appid = APPID;
        //        cusid = CUSID;
        //        trxcode = "T001";
        //        timestamp = DateTime.Now.ToString("yyyyMMddHHmmss", DateTimeFormatInfo.InvariantInfo);
        //        randomstr = (new Random().Next(8999) + 1000).ToString();

        //    }

        //}
        ///// <summary>
        ///// 将参数排序组装
        ///// </summary>
        ///// <param name="param"></param>
        ///// <returns></returns>
        //public static String BuildParamStr(Dictionary<String, String> param)
        //{
        //    if (param == null || param.Count == 0)
        //    {
        //        return "";
        //    }
        //    Dictionary<String, String> ascDic = param.OrderBy(o => o.Key).ToDictionary(o => o.Key, p => p.Value);
        //    StringBuilder sb = new StringBuilder();
        //    foreach (var item in ascDic)
        //    {
        //        sb.Append(item.Key).Append("=").Append(item.Value).Append("&");
        //    }

        //    return sb.ToString().Substring(0, sb.ToString().Length - 1);
        //}

        ///// <summary>
        ///// 将查询结果实体加签
        ///// </summary>
        ///// <param name="rsp"></param>
        //public static RspObj BuildSignRspObj(RspObj rsp, string APPKEY)
        //{
        //    Dictionary<String, String> param = new Dictionary<string, string>();
        //    if (!String.IsNullOrEmpty(rsp.appid))
        //    {
        //        param.Add("appid", rsp.appid);
        //    }
        //    if (!String.IsNullOrEmpty(rsp.cusid))
        //    {
        //        param.Add("cusid", rsp.cusid);
        //    }
        //    if (!String.IsNullOrEmpty(rsp.trxcode))
        //    {
        //        param.Add("trxcode", rsp.trxcode);
        //    }
        //    if (!String.IsNullOrEmpty(rsp.timestamp))
        //    {
        //        param.Add("timestamp", rsp.timestamp);
        //    }
        //    if (!String.IsNullOrEmpty(rsp.randomstr))
        //    {
        //        param.Add("randomstr", rsp.randomstr);
        //    }
        //    if (!String.IsNullOrEmpty(rsp.bizseq))
        //    {
        //        param.Add("bizseq", rsp.bizseq);
        //    }
        //    if (!String.IsNullOrEmpty(rsp.retcode))
        //    {
        //        param.Add("retcode", rsp.retcode);
        //    }
        //    if (!String.IsNullOrEmpty(rsp.retmsg))
        //    {
        //        param.Add("retmsg", rsp.retmsg);
        //    }
        //    if (!String.IsNullOrEmpty(rsp.amount))
        //    {
        //        param.Add("amount", rsp.amount);
        //    }
        //    if (!String.IsNullOrEmpty(rsp.trxreserve))
        //    {
        //        param.Add("trxreserve", rsp.trxreserve);
        //    }
        //    param.Add("key", APPKEY);
        //    String blankStr = BuildParamStr(param);
        //    String sign = Framework.Security.Crypt.MD5(blankStr);
        //    rsp.sign = sign;
        //    return rsp;
        //}
        //public void GetOrderMsg()
        //{
        //    var POSCUSID = "142581072993330";
        //    var POSAPPKEY = "1234567890";
        //    var POSAPPID = "00008692";
        //    String bizseq = "";
        //    RspObj rsp = new RspObj();
        //    for (int i = 0; i < Request.Form.Count; i++)
        //    {
        //        if (Request.Form.Keys[i] == "bizseq")
        //        {
        //            bizseq = Request.Form[i].ToString();
        //        }
        //    }
        //    this.vspExec = new VSPExec("142581072993330", "1234567890", "00008692");
          


        //    string formString = HttpUtility.UrlDecode(Request.Form.ToString());
        //    Dictionary<String, String> dicReqeust = formString.ToDictionary(true);
        //    if (vspExec.IsVerify(dicReqeust))//验签成功
        //    { 
        //        rsp.init("0000", "查询成功",  POSAPPID,  POSCUSID);
        //        rsp.amount = "1";
        //        // rsp.trxreserve = "05##测试用户5#上海徐汇#13012345678#18103000085#0#123456789123456789####";
        //        rsp.trxreserve = "05##备注#chen#16675579403#bizseq#######";
        //        rsp.bizseq = "20181107163729899799";//业务流水号


        //    }
        //    else //验签失败
        //    {
                

        //    }
        //    rsp = BuildSignRspObj(rsp,  POSAPPKEY);//签名 

        //    Response.Write(JsonHelper.Serialize(rsp));
        //}

        public string CreateOrderHousePayment(CreateOrderHousePaymentRequst request)   //房款订单创建接口
        {
            var result = new CreateOrderHousePaymentResponse() { requestno = request.requestno };

            var entity = new OrderHousePayment();

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                entity.MerchantID = request.MerchantID;
                entity.OrderNumber = GuidHelper.GenUniqueId();
                entity.ProjectManagementID = request.ProjectManagementID;
                entity.EquipmentNumber = request.EquipmentNumber;
                entity.TransactionAmount = request.TransactionAmount;
                entity.SerialNumber = request.SerialNumber;
                entity.PaymentStatus = request.PaymentStatus;
                entity.PaymentType = request.PaymentType;
                entity.Status = request.Status;
                entity.BankCardNumber = request.BankCardNumber;
                entity.Remark = request.Remark;
                entity.EmployeeID = request.EmployeeID;
                entity.MemberID = request.MemberID;

                iOrderHousePaymentService.Save(entity);
                iOrderHousePaymentService.Commit();
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            result.ordernumber = entity.OrderNumber;

            return JsonHelper.Serialize(result);
        }

        public string CreateOrderPaid(CreateOrderPaidRequst request)   //认缴订单创建接口
        {
            var result = new CreateOrderPaidResponse() { requestno = request.requestno };

            var entity = new OrderPaid();

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                entity.MerchantID = request.MerchantID;
                entity.OrderNumber = GuidHelper.GenUniqueId();
                entity.ProjectManagementID = request.ProjectManagementID;
                entity.EquipmentNumber = request.EquipmentNumber;
                entity.TransactionAmount = request.TransactionAmount;
                entity.SerialNumber = request.SerialNumber;
                entity.PaymentStatus = request.PaymentStatus;
                entity.PaymentType = request.PaymentType;
                entity.Status = request.Status;
                entity.BankCardNumber = request.BankCardNumber;
                entity.Remark = request.Remark;
                entity.EmployeeID = request.EmployeeID;
                entity.MemberID = request.MemberID;

                iOrderPaidService.Save(entity);
                iOrderPaidService.Commit();
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            result.ordernumber = entity.OrderNumber;

            return JsonHelper.Serialize(result);
        }


        public string CreateMember(CreateMemberRequst request)   //会员信息创建接口
        {
            var result = new CreateMemberResponse() { requestno = request.requestno };

            var entity = new Member();

            try
            {
                if (!ModelState.IsValid)
                    throw new APIException(ModelState.Values.Where(t => t.Errors.Count > 0).FirstOrDefault().Errors.FirstOrDefault().ErrorMessage);

                entity.Name = request.Name;
                entity.Mobile = request.Mobile;
                entity.IDNumber = request.IDNumber;

                iMemberManagementService.Save(entity);
                iMemberManagementService.Commit();
            }
            catch (APIException ex)
            {
                result.resultmsg = ex.Message;
                result.retsultcode = ex.ErrorCode;
            }

            result.memberid = entity.ID.ToString();

            return JsonHelper.Serialize(result);
        }


    }
}